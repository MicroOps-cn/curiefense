<template>
  <div>
    <div class="card">
      <div class="card-content">
        <div class="media">
          <div class="media-content">
            <div class="columns columns-divided">
              <div class="column is-4">
                <div class="field">
                  <label class="label is-small">
                    Name
                    <span class="has-text-grey is-pulled-right document-id"
                          title="Document id">
                    {{ localDoc.id }}
                  </span>
                  </label>
                  <div class="control">
                    <input class="input is-small document-name"
                           title="Document name"
                           placeholder="Document name"
                           @change="emitDocUpdate"
                           v-model="localDoc.name"/>
                  </div>
                </div>
                <div class="field">
                  <label class="label is-small">
                    Masking Seed
                  </label>
                  <div class="control">
                    <input class="input is-small document-masking-seed"
                           title="Masking seed"
                           placeholder="Masking seed"
                           type="password"
                           @change="emitDocUpdate"
                           v-model="localDoc.masking_seed"/>
                  </div>
                </div>
                <div class="field">
                  <label class="label is-small">
                    Content Type
                  </label>
                  <div class="control">
                    <input class="input is-small document-masking-seed"
                           title="Content type"
                           placeholder="Comma separated content types"
                           @change="emitDocUpdate"
                           v-model="commaSeparatedContentType"/>
                  </div>
                </div>
              </div>
              <div class="column is-4">
                <div class="field">
                  <label class="label is-small">
                    Decoding
                  </label>
                  <div class="control">
                    <div class="columns">
                      <div class="column is-6">
                        <div class="decoding-option-wrapper mb-3">
                          <label class="checkbox is-size-7">
                            <input type="checkbox"
                                   @change="emitDocUpdate"
                                   class="checkbox-input decoding-base64-active"
                                   v-model="localDoc.decoding.base64">
                            base64
                          </label>
                        </div>
                        <div class="decoding-option-wrapper">
                          <label class="checkbox is-size-7">
                            <input type="checkbox"
                                   @change="emitDocUpdate"
                                   class="checkbox-input decoding-dual-active"
                                   v-model="localDoc.decoding.dual">
                            URL
                          </label>
                        </div>
                      </div>
                      <div class="column is-6">
                        <div class="decoding-option-wrapper mb-3">
                          <label class="checkbox is-size-7">
                            <input type="checkbox"
                                   @change="emitDocUpdate"
                                   class="checkbox-input decoding-html-active"
                                   v-model="localDoc.decoding.html">
                            html
                          </label>
                        </div>
                        <div class="decoding-option-wrapper">
                          <label class="checkbox is-size-7">
                            <input type="checkbox"
                                   @change="emitDocUpdate"
                                   class="checkbox-input decoding-unicode-active"
                                   v-model="localDoc.decoding.unicode">
                            unicode
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tile is-ancestor px-3 py-3 mx-0 my-0">
          <div class="tile is-9">
            <table class="table is-fullwidth">
              <thead>
              <tr>
                <th></th>
                <th class="has-text-centered">Headers</th>
                <th class="has-text-centered">Cookies</th>
                <th class="has-text-centered">Arguments</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td>Max Length</td>
                <td>
                  <input required
                         class="input is-small max-header-length-input"
                         type="number"
                         @change="emitDocUpdate"
                         title="Max header length"
                         v-model.number="localDoc.headers.max_length"/>
                </td>
                <td>
                  <input required
                         class="input is-small max-cookie-length-input"
                         type="number"
                         @change="emitDocUpdate"
                         title="Max cookie length"
                         v-model.number="localDoc.cookies.max_length"/>
                </td>
                <td>
                  <input required
                         class="input is-small max-arg-length-input"
                         type="number"
                         @change="emitDocUpdate"
                         title="Max argument length"
                         v-model.number="localDoc.args.max_length"/>
                </td>
              </tr>
              <tr>
                <td>Max Count</td>
                <td>
                  <input required
                         class="input is-small max-headers-count-input"
                         type="number"
                         @change="emitDocUpdate"
                         title="Max headers count"
                         v-model.number="localDoc.headers.max_count"/>
                </td>
                <td>
                  <input required
                         class="input is-small max-cookies-count-input"
                         type="number"
                         @change="emitDocUpdate"
                         title="Max cookies count"
                         v-model.number="localDoc.cookies.max_count"/>
                </td>
                <td>
                  <input required
                         class="input is-small max-args-count-input"
                         type="number"
                         @change="emitDocUpdate"
                         title="Max arguments count"
                         v-model.number="localDoc.args.max_count"/>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
          <div class="tile is-3">
            <div class="card">
              <div class="card-content">
                <label class="checkbox">
                  <input type="checkbox"
                         class="ignore-alphanumeric-input"
                         @change="emitDocUpdate"
                         v-model="localDoc.ignore_alphanum"/>
                  Ignore Alphanumeric input
                </label>
                <p class="help">When checked, arguments, headers or cookies, which contain only alpha numeric
                  characters, will be ignored.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="columns px-3 py-3 mx-0 my-0">
          <div class="column is-4" v-for="operation in operations" :key="operation">
            <p class="title is-7 is-uppercase">{{ titles[operation] }}</p>
            <hr class="bar" :class="`bar-${operation}`"/>
            <table class="table is-narrow is-fullwidth">
              <tbody>
              <tr v-for="(tag, idx) in localDoc[operation]" :key="idx">
                <td class="tag-cell ellipsis"
                    :class=" { 'has-text-danger': duplicateTags[tag] }"
                    :title="tagMessage(tag) || tag">
                  {{ tag }}
                </td>
                <td class="is-size-7 width-20px">
                  <a title="remove entry"
                     tabindex="0"
                     class="is-small has-text-grey remove-entry-button"
                     @click="removeTag(operation, idx)"
                     @keypress.space.prevent
                     @keypress.space="removeTag(operation, idx)"
                     @keypress.enter="removeTag(operation, idx)">
                    &ndash;
                  </a>
                </td>
              </tr>
              <tr>
                <td>
                  <autocomplete-input
                      v-if="addNewColName === operation"
                      input-type="input"
                      selection-type="single"
                      title="Tag"
                      :minimum-value-length="2"
                      :clear-input-after-selection="true"
                      :auto-focus="true"
                      @keydown.esc="cancelAddNewTag"
                      @value-submitted="addTag(operation, $event)"/>
                </td>
                <td class="is-size-7 width-20px">
                  <a title="add new entry"
                     tabindex="0"
                     class="is-size-7 width-20px is-small has-text-grey add-new-entry-button"
                     @click="openTagInput(operation)"
                     @keypress.space.prevent
                     @keypress.space="openTagInput(operation)"
                     @keypress.enter="openTagInput(operation)">
                    +
                  </a>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="tile is-ancestor px-3 py-3 mx-0 my-0">
          <div class="tile is-parent">
            <div class="tile is-12">
              <table class="table is-fullwidth">
                <tr>
                  <td>
                    <div class="tabs is-centered">
                      <ul>
                        <li :class=" tab === 'headers' ? 'is-active' : '' "
                            class="headers-tab">
                          <a tabindex="0"
                             @click='tab="headers"'
                             @keypress.space.prevent
                             @keypress.space='tab="headers"'
                             @keypress.enter='tab="headers"'>
                            Headers
                          </a>
                        </li>
                        <li :class=" tab === 'cookies' ? 'is-active' : '' "
                            class="cookies-tab">
                          <a tabindex="0"
                             @click='tab="cookies"'
                             @keypress.space.prevent
                             @keypress.space='tab="cookies"'
                             @keypress.enter='tab="cookies"'>
                            Cookies
                          </a>
                        </li>
                        <li :class=" tab === 'args' ? 'is-active' : '' "
                            class="args-tab">
                          <a tabindex="0"
                             @click='tab="args"'
                             @keypress.space.prevent
                             @keypress.space='tab="args"'
                             @keypress.enter='tab="args"'>
                            Arguments
                          </a>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <table class="table is-fullwidth is-hoverable"
                           v-if="localDoc && localDoc[tab]">
                      <thead>
                      <tr>
                        <th class="has-text-centered width-30pct">Parameter</th>
                        <th class="has-text-centered width-25pct">Matching Value</th>
                        <th class="has-text-centered width-5pct">Restrict?</th>
                        <th class="has-text-centered width-5pct">Mask?</th>
                        <th class="has-text-centered width-30pct">Ignore Content Filter</th>
                        <th class="has-text-centered width-5pct">
                          <a v-show="newContentFilterLine !== tab"
                             class="has-text-grey-dark is-small new-parameter-button"
                             title="Add new parameter"
                             tabindex="0"
                             @click="openAddNewParameter(tab)"
                             @keypress.space.prevent
                             @keypress.space="openAddNewParameter(tab)"
                             @keypress.enter="openAddNewParameter(tab)">
                            <span class="icon is-small"><i class="fas fa-plus"></i></span>
                          </a>
                          <a v-show="newContentFilterLine === tab"
                             class="has-text-grey-dark is-small cancel-new-parameter"
                             title="Cancel adding new parameter"
                             tabindex="0"
                             @click="cancelNewParemeter"
                             @keypress.space.prevent
                             @keypress.space="cancelNewParemeter"
                             @keypress.enter="cancelNewParemeter">
                            <span class="icon is-small"><i class="fas fa-minus"></i></span>
                          </a>
                        </th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr v-if="newContentFilterLine === tab"
                          class="has-background-warning-light new-parameter-row">
                        <td class="px-0 py-0 width-30pct">
                          <table class="table is-fullwidth has-background-warning-light">
                            <tr>
                              <td class="is-fullwidth">
                                <div class="field">
                                  <div class="control">
                                    <div class="select is-small">
                                      <select v-model="newEntry.type"
                                              class="new-entry-type"
                                              title="Type">
                                        <option value="names">
                                          {{ titles.names }}
                                        </option>
                                        <option value="regex">
                                          {{ titles.regex }}
                                        </option>
                                      </select>
                                    </div>
                                  </div>
                                </div>
                              </td>
                              <td>
                                <div class="field">
                                  <div class="control">
                                    <div>
                                      <input required
                                             class="input is-small new-entry-key"
                                             type="text"
                                             v-model="newEntry.key"
                                             placeholder="Key"
                                             title="Key"/>
                                    </div>
                                  </div>
                                </div>
                              </td>
                            </tr>
                          </table>
                        </td>
                        <td class="width-25pct">
                          <p class="control has-icons-left">
                            <input required
                                   class="input is-small new-entry-reg"
                                   type="text"
                                   v-model="newEntry.reg"
                                   placeholder="Value"
                                   title="Value regex"/>
                            <span class="icon is-small is-left has-text-grey">
                              <i class="fas fa-code"></i>
                            </span>
                          </p>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <label class="checkbox">
                            <input type="checkbox"
                                   class="new-entry-restrict"
                                   v-model="newEntry.restrict"/>
                          </label>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <label class="checkbox">
                            <input type="checkbox"
                                   class="new-entry-mask"
                                   v-model="newEntry.mask"/>
                          </label>
                        </td>
                        <td class="width-30pct">
                          <autocomplete-input
                              input-type="textarea"
                              :suggestions="entryExclusionsSuggestions(newEntry)"
                              :clear-input-after-selection="false"
                              :auto-focus="false"
                              class="new-entry-exclusions"
                              selection-type="multiple"
                              :title="autocompleteTitle"
                              @value-submitted="updateEntryExclusions(newEntry, $event)"/>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <button title="Add new parameter"
                                  class="button is-light is-small confirm-add-new-parameter"
                                  @click="addNewParameter">
                            <span class="icon is-small"><i class="fas fa-plus fa-xs"></i></span>
                          </button>
                        </td>
                      </tr>
                      <tr v-for="(entry, idx) in localDoc[tab].names"
                          class="entry-row"
                          :key="genRowKey(tab, 'names', idx)">
                        <td class="width-30pct">
                          <div class="field">
                            <p class="control has-icons-left">
                              <input required
                                     class="input is-small entry-key"
                                     type="text"
                                     @change="emitDocUpdate"
                                     v-model="entry.key"
                                     placeholder="Key"
                                     title="Key name"/>
                              <span class="icon is-small is-left has-text-grey">
                                <i class="fas fa-font"></i>
                              </span>
                            </p>
                          </div>
                        </td>
                        <td class="width-25pct">
                          <p class="control has-icons-left">
                            <input required
                                   class="input is-small entry-reg"
                                   type="text"
                                   @change="emitDocUpdate"
                                   v-model="entry.reg"
                                   placeholder="Value"
                                   title="Value regex"/>
                            <span class="icon is-small is-left has-text-grey">
                              <i class="fas fa-code"></i>
                            </span>
                          </p>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <label class="checkbox">
                            <input type="checkbox"
                                   class="entry-restrict"
                                   @change="emitDocUpdate"
                                   v-model="entry.restrict"/>
                          </label>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <label class="checkbox">
                            <input type="checkbox"
                                   class="entry-mask"
                                   @change="emitDocUpdate"
                                   v-model="entry.mask"/>
                          </label>
                        </td>
                        <td class="width-30pct">
                          <autocomplete-input
                              input-type="textarea"
                              :suggestions="entryExclusionsSuggestions(entry)"
                              :clear-input-after-selection="false"
                              :initial-value="unpackExclusions(entry.exclusions)"
                              :auto-focus="false"
                              class="entry-exclusions"
                              selection-type="multiple"
                              :title="autocompleteTitle"
                              @value-submitted="updateEntryExclusions(entry, $event)"/>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <button title="Delete entry"
                                  :data-curie="genRowKey(tab, 'names', idx)"
                                  @click="deleteEntryRow(tab, 'names', idx)"
                                  class="button is-light is-small remove-entry-button">
                              <span class="icon is-small">
                                <i class="fas fa-trash fa-xs"></i>
                              </span>
                          </button>
                        </td>
                      </tr>
                      <tr v-for="(entry, idx) in localDoc[tab].regex"
                          class="entry-row"
                          :key="genRowKey(tab, 'regex', idx)">
                        <td class="width-30pct">
                          <div class="field">
                            <p class="control has-icons-left">
                              <input required
                                     class="input is-small entry-key"
                                     type="text"
                                     @change="emitDocUpdate"
                                     v-model="entry.key"
                                     placeholder="Key"
                                     title="Key regex"/>
                              <span class="icon is-small is-left has-text-grey">
                                <i class="fas fa-code"></i>
                              </span>
                            </p>
                          </div>
                        </td>
                        <td class="width-25pct">
                          <p class="control has-icons-left">
                            <input required
                                   class="input is-small entry-reg"
                                   type="text"
                                   @change="emitDocUpdate"
                                   v-model="entry.reg"
                                   placeholder="Value"
                                   title="Value regex"/>
                            <span class="icon is-small is-left has-text-grey">
                                  <i class="fas fa-code"></i>
                            </span>
                          </p>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <label class="checkbox">
                            <input type="checkbox"
                                   class="entry-restrict"
                                   @change="emitDocUpdate"
                                   v-model="entry.restrict"/>
                          </label>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <label class="checkbox">
                            <input type="checkbox"
                                   class="entry-mask"
                                   @change="emitDocUpdate"
                                   v-model="entry.mask"/>
                          </label>
                        </td>
                        <td class="width-30pct">
                          <autocomplete-input
                              input-type="textarea"
                              :suggestions="entryExclusionsSuggestions(entry)"
                              :clear-input-after-selection="false"
                              :initial-value="unpackExclusions(entry.exclusions)"
                              :auto-focus="false"
                              class="entry-exclusions"
                              selection-type="multiple"
                              :title="autocompleteTitle"
                              @value-submitted="updateEntryExclusions(entry, $event)"/>
                        </td>
                        <td class="has-text-centered width-5pct">
                          <button title="Delete entry"
                                  :data-curie="genRowKey(tab, 'regex', idx)"
                                  @click="deleteEntryRow(tab, 'regex', idx)"
                                  class="button is-light is-small remove-entry-button">
                              <span class="icon is-small">
                                <i class="fas fa-trash fa-xs"></i>
                              </span>
                          </button>
                        </td>
                      </tr>
                      </tbody>
                    </table>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <span class="is-family-monospace has-text-grey-lighter">{{ apiPath }}</span>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import _ from 'lodash'
import DatasetsUtils from '@/assets/DatasetsUtils.ts'
import Vue from 'vue'
import {
  ArgsCookiesHeadersType,
  ContentFilterEntryMatch,
  ContentFilterIgnoreType,
  ContentFilterProfile,
  ContentFilterProfileSection,
  ContentFilterProfileSectionType,
  ContentFilterProfileTagLists,
  ContentFilterRule,
  ContentFilterRuleGroup,
  NamesRegexType,
} from '@/types'
import AutocompleteInput, {AutocompleteSuggestion} from '@/components/AutocompleteInput.vue'
import RequestsUtils from '@/assets/RequestsUtils'
import {Dictionary} from 'vue-router/types/router'
import Utils from '@/assets/Utils'

export default Vue.extend({
  name: 'ContentFilterEditor',
  components: {AutocompleteInput},
  props: {
    selectedDoc: Object,
    selectedBranch: String,
    apiPath: String,
  },

  data() {
    const defaultNewEntry: ContentFilterEntryMatch = {
      type: 'names',
      key: '',
      reg: '',
      restrict: false,
      mask: false,
      exclusions: {},
    }
    const defaultContentFilterProfileSection: ContentFilterProfileSection = {
      names: [] as ContentFilterEntryMatch[],
      regex: [] as ContentFilterEntryMatch[],
      max_count: 0,
      max_length: 0,
    }
    const defaultContentFilterProfileDecoding: ContentFilterProfile['decoding'] = {
      base64: true,
      dual: false,
      html: false,
      unicode: false,
    }
    return {
      operations: ['active', 'report', 'ignore'] as ContentFilterProfileTagLists[],
      addNewColName: null,
      tab: 'args' as ArgsCookiesHeadersType,
      newContentFilterLine: null as ArgsCookiesHeadersType,
      newEntry: defaultNewEntry,
      titles: DatasetsUtils.titles,
      defaultNewEntry: defaultNewEntry,
      defaultContentFilterProfileSection: defaultContentFilterProfileSection,
      defaultContentFilterProfileDecoding: defaultContentFilterProfileDecoding,
      contentFilterSuggestions: [] as AutocompleteSuggestion[],
      contentFilter: {
        group: [] as ContentFilterRuleGroup[],
        rule: [] as ContentFilterRule[],
      },
      autocompleteTitle: 'Rule or group name',
      groupSuffix: '(Group)',
    }
  },

  computed: {
    localDoc(): ContentFilterProfile {
      return _.cloneDeep(this.selectedDoc)
    },

    duplicateTags(): Dictionary<string> {
      const doc = this.localDoc
      const allTags = _.concat(doc['active'], doc['report'], doc['ignore'])
      const dupTags = _.filter(allTags, (val, i, iteratee) => _.includes(iteratee, val, i + 1))
      const result = _.fromPairs(_.zip(dupTags, dupTags))
      this.$emit('form-invalid', !!_.size(result))
      return result
    },

    commaSeparatedContentType: {
      get(): string {
        return this.localDoc.content_type?.join(', ') || ''
      },
      set(val: string): void {
        this.localDoc.content_type = val.trim().split(/[, ]+/)
      },
    },
  },

  methods: {
    emitDocUpdate() {
      this.$emit('update:selectedDoc', this.localDoc)
    },

    openAddNewParameter(tab: ArgsCookiesHeadersType) {
      this.newContentFilterLine = tab
      this.newEntry = {...this.defaultNewEntry}
    },

    cancelNewParemeter() {
      this.newContentFilterLine = null
      this.newEntry = {...this.defaultNewEntry}
    },

    addNewParameter() {
      const newEntry = _.cloneDeep(this.newEntry)
      this.newEntry = null
      this.newContentFilterLine = null
      const type: NamesRegexType = newEntry.type
      delete newEntry.type
      this.localDoc[this.tab][type].unshift(newEntry)
      this.emitDocUpdate()
    },

    updateEntryExclusions(entry: ContentFilterEntryMatch, exclusions: string) {
      const result: ContentFilterEntryMatch['exclusions'] = {}
      const exclusionsArray: string[] = exclusions.trim().split('\n')
      exclusionsArray.forEach((ex) => {
        const exclusionType = ex.endsWith(this.groupSuffix) ? 'group' : 'rule'
        const exId = this.getContentFilterId(exclusionType, ex)
        if (exId) {
          result[exId] = exclusionType
        }
      })
      entry.exclusions = result
      this.emitDocUpdate()
    },

    entryExclusionsSuggestions({exclusions}: ContentFilterEntryMatch) {
      return _.filter(this.contentFilterSuggestions, ({value}) => {
        const exclusionType = value.endsWith(this.groupSuffix) ? 'group' : 'rule'
        const exId = this.getContentFilterId(exclusionType, value)
        return !exclusions?.[exId]
      })
    },

    unpackExclusions(exclusions: ContentFilterEntryMatch['exclusions']) {
      const result: string[] = []
      Object.keys(exclusions).forEach(
          (exId) => {
            const exclusionType = exclusions[exId]
            const name = (this.contentFilter[exclusionType] as (ContentFilterRule | ContentFilterRuleGroup)[])?.find(
                ({id}) => id === exId,
            )?.name
            if (name) {
              result.push(exclusionType === 'group' ? `${name} ${this.groupSuffix}` : name)
            }
          },
      )
      return result.join('\n')
    },

    getContentFilterId(exclusionType: ContentFilterIgnoreType, exclusions: string) {
      return (this.contentFilter[exclusionType] as (ContentFilterRule | ContentFilterRuleGroup)[]).find(
          ({name}) => exclusions.includes(name),
      )?.id
    },

    genRowKey(tab: string, type: string, idx: number) {
      return `${tab}-${type}-${idx}`
    },

    deleteEntryRow(tab: ArgsCookiesHeadersType, type: NamesRegexType, index: number) {
      this.localDoc[tab][type].splice(index, 1)
      this.emitDocUpdate()
    },

    async loadContentFilterRuleIDs() {
      const [cfRules, cfGroups] = await Promise.all([
        RequestsUtils.sendRequest({
          methodName: 'GET',
          url: `configs/${this.selectedBranch}/d/contentfilterrules/`,
          config: {headers: {'x-fields': 'id, name'}},
        }),
        RequestsUtils.sendRequest({
          methodName: 'GET',
          url: `configs/${this.selectedBranch}/d/contentfiltergroups/`,
          config: {headers: {'x-fields': 'id, name'}},
        }),
      ])
      this.contentFilter = {
        rule: cfRules.data,
        group: cfGroups.data,
      }
      this.contentFilterSuggestions = [
        ..._.sortBy(_.map(this.contentFilter.rule, ({name}) => ({value: name}))),
        ..._.sortBy(_.map(this.contentFilter.group, ({name}) => ({value: `${name} ${this.groupSuffix}`}))),
      ]
    },

    normalizeDocSections(section: ContentFilterProfileSectionType) {
      this.localDoc[section] = _.cloneDeep(this.defaultContentFilterProfileSection)
      this.emitDocUpdate()
    },

    normalizeDocDecoding() {
      this.localDoc.decoding = _.cloneDeep(this.defaultContentFilterProfileDecoding)
      this.emitDocUpdate()
    },

    openTagInput(section: ContentFilterProfileTagLists) {
      this.addNewColName = section
    },

    cancelAddNewTag() {
      this.addNewColName = null
    },

    addTag(section: ContentFilterProfileTagLists, entry: string) {
      entry = Utils.removeExtraWhitespaces(entry).trim()
      this.localDoc[section].push(entry)
      this.emitDocUpdate()
    },

    removeTag(section: ContentFilterProfileTagLists, index: number) {
      this.localDoc[section].splice(index, 1)
      this.addNewColName = null
      this.emitDocUpdate()
    },

    tagMessage(tag: string) {
      let message = ''
      if (this.duplicateTags[tag]) {
        message = `[${tag}] is duplicated`
      }
      return message
    },
  },

  created() {
    this.loadContentFilterRuleIDs()
  },

  watch: {
    selectedDoc: {
      handler: function(value) {
        // adding necessary fields to all local doc sections if missing
        const sections: ContentFilterProfileSectionType[] = ['args', 'cookies', 'headers', 'path']
        for (let i = 0; i < sections.length; i++) {
          if (!value[sections[i]]) {
            this.normalizeDocSections(sections[i])
          }
        }
        if (!value['decoding']) {
          this.normalizeDocDecoding()
        }
      },
      immediate: true,
      deep: true,
    },
  },
})
</script>

<style scoped lang="scss">

@import 'node_modules/bulma/sass/utilities/initial-variables.sass';
@import 'node_modules/bulma/sass/utilities/functions.sass';
@import 'node_modules/bulma/sass/utilities/derived-variables.sass';
@import 'node_modules/bulma/sass/helpers/color.sass';

.dropdown .dropdown-menu {
  width: auto;
}

.bar {
  margin: 1rem 0 0.5rem;
}

.bar-active {
  @extend .has-background-grey-light;
}

.bar-report {
  @extend .has-background-grey-light;
}

.bar-ignore {
  @extend .has-background-grey-light;
}

::v-deep .tag-input {
  font-size: 0.58rem;
}

.decoding-option-wrapper {
  .checkbox-input {
    vertical-align: text-bottom;
  }
}

</style>
